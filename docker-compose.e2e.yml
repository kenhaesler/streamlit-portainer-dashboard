# Docker Compose configuration for E2E testing
# Usage: docker compose -f docker-compose.e2e.yml up -d --wait

services:
  # FastAPI Backend for E2E tests
  backend-test:
    build:
      context: .
      dockerfile: tests/e2e/Dockerfile.backend
    ports:
      - "8001:8000"
    environment:
      # Authentication
      - DASHBOARD_AUTH_PROVIDER=static
      - DASHBOARD_USERNAME=testuser
      - DASHBOARD_KEY=testpass
      - DASHBOARD_SESSION_TIMEOUT_MINUTES=60
      - DASHBOARD_SESSION_BACKEND=memory

      # Portainer - using mock server
      - PORTAINER_API_URL=http://portainer-mock:1080/api
      - PORTAINER_API_KEY=test-api-key
      - PORTAINER_VERIFY_SSL=false
      - PORTAINER_CACHE_ENABLED=false

      # LLM - using mock server
      - LLM_API_ENDPOINT=http://llm-mock:1080/v1/chat/completions
      - LLM_MODEL=test-model
      - LLM_BEARER_TOKEN=test-token
      - LLM_TIMEOUT=30

      # Disable AI monitoring for faster tests
      - MONITORING_ENABLED=false
      - MONITORING_METRICS_ENABLED=false

      # Disable tracing for tests
      - TRACING_ENABLED=false

      # Disable self-healing for tests
      - REMEDIATION_ENABLED=false
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s
    depends_on:
      portainer-mock:
        condition: service_started
      llm-mock:
        condition: service_started

  # Streamlit Frontend for E2E tests
  frontend-test:
    build:
      context: .
      dockerfile: tests/e2e/Dockerfile.frontend
    ports:
      - "8503:8502"
    environment:
      - FASTAPI_BACKEND_URL=http://backend-test:8000
    depends_on:
      backend-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8502/_stcore/health').raise_for_status()"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

  # MockServer for Portainer API
  portainer-mock:
    image: mockserver/mockserver:5.15.0
    ports:
      - "3000:1080"
    environment:
      - MOCKSERVER_INITIALIZATION_JSON_PATH=/config/portainer-mock.json
      - MOCKSERVER_LOG_LEVEL=WARN
    volumes:
      - ./tests/e2e/mocks:/config:ro

  # MockServer for LLM API
  llm-mock:
    image: mockserver/mockserver:5.15.0
    ports:
      - "3001:1080"
    environment:
      - MOCKSERVER_INITIALIZATION_JSON_PATH=/config/llm-mock.json
      - MOCKSERVER_LOG_LEVEL=WARN
    volumes:
      - ./tests/e2e/mocks:/config:ro

networks:
  default:
    driver: bridge
